@page
@using MediaStream.Controllers
@using Newtonsoft.Json.Linq
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@model MediaStream.Pages.profileModel
@{
	// This is a terrible hack, but I don't care. What's the worst that could happen?
	string id = "admin";
	if (HttpContextAccessor.HttpContext.Request.Cookies["username"] == null)
	{
		Response.Redirect("/login");
	}
	else
	{
		id = HttpContextAccessor.HttpContext.Request.Cookies["username"];
	}
	string datapath = @"D:\Freestyle\Debug\net6.0\data\";
	FileStream stream = new(datapath + @"profiles\" + id, FileMode.Open, FileAccess.Read);
	byte[] result = new byte[stream.Length];
	_ = await stream.ReadAsync(result, 0, (int)stream.Length);
	string data = System.Text.Encoding.UTF8.GetString(result);
	JObject json = JObject.Parse(data);
	FileStream userstream = new(datapath + @"user\" + id, FileMode.Open, FileAccess.Read);
	byte[] userresult = new byte[userstream.Length];
	_ = await userstream.ReadAsync(userresult, 0, (int)userstream.Length);
	string userdata = System.Text.Encoding.UTF8.GetString(userresult);
	JObject userjson = JObject.Parse(userdata);
	if (userjson["groupsMade"] == null)
	{
		userjson.Add("groupsMade", new JArray());
	}
	stream.Close();
	stream.Dispose();
	userstream.Close();
	userstream.Dispose();
	Layout = "_Layout";
	int type = -1;
	if (Request.Cookies["username"] == json["name"].ToString())
	{
		type = 1;
	}
	else
	{
		if (json["followersList"].ToString().Contains("\"" + Request.Cookies["username"] + "\""))
		{
			type = 3;
		}
		else
		{
			type = 2;
		}
	}
	string profilepagelink = "/studio";
	byte verify = 0;
	if (json["verify"] != null)
	{
		verify = byte.Parse(json["verify"].ToString());
	}
}
<!--[if lt IE 9]>
<meta http-equiv="refresh" content="0; url=/migration" />
<![endif]-->
<tr>
	<td colspan="2" class="fontfamily">
		<div>
			@{
				JArray fuck = JArray.Parse(userjson["groupsMade"].ToString());
				List<JObject> groups = new List<JObject>();
				for (int i = 0; i < fuck.Count; i++)
				{
					FileStream videostream = new(datapath + @"groups\" + fuck[i].ToString(), FileMode.Open, FileAccess.Read);
					byte[] videoresult = new byte[videostream.Length];
					_ = await videostream.ReadAsync(videoresult, 0, (int)videostream.Length);
					string videodata = System.Text.Encoding.UTF8.GetString(videoresult);
					JObject videojson = JObject.Parse(videodata);
					JObject finJson = JObject.Parse("{" + "}");
					finJson.Add("name", videojson["name"].ToString());
					finJson.Add("id", fuck[i].ToString());
					finJson.Add("views", videojson["views"].ToString());
					finJson.Add("date", videojson["date"].ToString());
					finJson.Add("desc", videojson["desc"].ToString());
					finJson.Add("vids", JArray.Parse(videojson["videosMade"].ToString()).Count.ToString());
					if (videojson["category"] != null)
					{
						finJson.Add("category", videojson["category"].ToString());
					}
					else
					{
						finJson.Add("category", "none");
					}

					groups.Add(finJson);
					videostream.Close();
					videostream.Dispose();
				}
			}

			<div class="navbar" style="text-align: center;margin-bottom:16px;">
				<span style="font-size:14px;">
					<a href="@(profilepagelink + "/prof")">Profile</a><span class="textseparator"> | </span><a href="@(profilepagelink + "/vid")">Videos</a><span class="textseparator"> | </span><a href="@(profilepagelink + "/playlist")">Playlists</a><span class="textseparator"> | </span><a href="@(profilepagelink + "/group")">Groups</a><span class="textseparator"> | </span><a href="@(profilepagelink + "/comment")">Comments</a><span class="textseparator"> | </span><a href="@(profilepagelink + "/activity")">Activity</a>
				</span>
			</div>

			<div class="homeheader"><span style="font-size:14px;"><strong>My Groups (@fuck.Count)</strong></span></div>

			<div class="homeheader">
				<div style="display: inline-block; margin-right: 8px;">
					@foreach (JObject group in groups)
					{
						<div style="display: block; float: left; margin-bottom: 8px; width: 360px;">
							<table border="0" cellpadding="0" cellspacing="0" style="float: left;">
								<tbody>
									<tr>
										<td colspan="2"><a href="/group?id=@group["id"].ToString()">@group["name"].ToString()</a></td>
									</tr>
									<tr>
										<td rowspan="2"><a href="/group?id=@group["id"].ToString()"><img alt="" src="~/api/thumb?id=@group["id"].ToString()&type=group" style="width: 64px; height: 64px;" /></a></td>
										<td class="user" rowspan="2">
											<div style="height:32px; overflow: hidden">@group["desc"].ToString()</div>

											<div class="smallgray">@group["vids"].ToString() Videos</div>

											<div class="smallgray">@group["views"].ToString() Views</div>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					}
				</div>
			</div>
		</div>
	</td>
</tr>
