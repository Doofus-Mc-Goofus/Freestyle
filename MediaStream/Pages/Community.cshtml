@page
@using Newtonsoft.Json.Linq
@using System.IO
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@model MediaStream.Pages.IndexModel
@{
	Random random = new Random();
	string datapath = @"D:\Freestyle\Debug\net6.0\data\";
	Layout = "_Layout";

}
<!--[if lt IE 9]>
<meta http-equiv="refresh" content="0; url=/migration" />
<![endif]-->
<tr>
	<td>
		<div class="homeheader"><span style="font-size: 14px;"><strong>Popular People</strong></span></div>
		<hr style="margin-right:55px;" />
		@{
			List<JObject> people = new List<JObject>();
			DirectoryInfo persondirectoryInfo = new DirectoryInfo(datapath + @"profiles\");
			FileInfo[] personfiles = persondirectoryInfo.GetFiles();
			for (int i = 0; i < 8; i++)
			{
				var id = random.Next(0, personfiles.Count());
				FileStream stream = new(personfiles[id].FullName, FileMode.Open, FileAccess.Read);
				byte[] result = new byte[stream.Length];
				_ = await stream.ReadAsync(result, 0, (int)stream.Length);
				string data = System.Text.Encoding.UTF8.GetString(result);
				JObject json = JObject.Parse(data);
				JObject finJson = JObject.Parse("{" + "}");
				finJson.Add("name", json["name"].ToString());
				finJson.Add("did", json["did"].ToString());
				finJson.Add("displayName", ((json["displayName"] != null) ? json["displayName"].ToString() : json["name"].ToString()));
				finJson.Add("bio", json["bio"].ToString());
				finJson.Add("views", json["views"].ToString());
				finJson.Add("vids", JArray.Parse(json["videosMade"].ToString()).Count.ToString());
				people.Add(finJson);
				stream.Close();
				stream.Dispose();
			}
		}
		<div style="display: inline-block;">
			@foreach (JObject person in people)
			{
				<div style="display: block; float: left; margin-bottom: 8px; width: 300px;">
					<table border="0" cellpadding="0" cellspacing="0" style="float: left;">
						<tbody>
							<tr>
								<td colspan="2"><a title="@person["name"].ToString()" href="/profile?id=@person["did"].ToString()">@person["displayName"].ToString()</a></td>
							</tr>
							<tr>
								<td rowspan="2"><a href="/profile?id=@person["did"].ToString()"><img alt="" src="~/api/thumb?id=@person["name"].ToString()&type=user" style="width: 64px; height: 64px;" /></a></td>
								<td class="user" rowspan="2">
									<div style="height:32px; overflow: hidden">@person["bio"].ToString()</div>

									<div class="smallgray">@person["vids"].ToString() Videos</div>

									<div class="smallgray">@person["views"].ToString() Views</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			}
		</div>
		<div>&nbsp;</div>
		@{
			List<JObject> groups = new List<JObject>();
			for (int i = 0; i < 8; i++)
			{
				string id = await MediaStream.Controllers.Feeds.RandomPublicGroup();
				FileStream videostream = new(datapath + @"groups\" + id, FileMode.Open, FileAccess.Read);
				byte[] videoresult = new byte[videostream.Length];
				_ = await videostream.ReadAsync(videoresult, 0, (int)videostream.Length);
				string videodata = System.Text.Encoding.UTF8.GetString(videoresult);
				JObject videojson = JObject.Parse(videodata);
				JObject finJson = JObject.Parse("{" + "}");
				finJson.Add("name", videojson["name"].ToString());
				finJson.Add("id", id);
				finJson.Add("views", videojson["views"].ToString());
				finJson.Add("date", videojson["date"].ToString());
				finJson.Add("desc", videojson["desc"].ToString());
				finJson.Add("vids", JArray.Parse(videojson["videosMade"].ToString()).Count.ToString());
				if (videojson["category"] != null)
				{
					finJson.Add("category", videojson["category"].ToString());
				}
				else
				{
					finJson.Add("category", "none");
				}

				groups.Add(finJson);
				videostream.Close();
				videostream.Dispose();
			}
		}

		<div class="homeheader"><span style="font-size:14px;"><strong>Popular Groups</strong></span></div>
		<hr style="margin-right:55px;" />
		<div style="display: inline-block;">
			@foreach (JObject group in groups)
			{
				<div style="display: block; float: left; margin-bottom: 8px; width: 300px;">
					<table border="0" cellpadding="0" cellspacing="0" style="float: left;">
						<tbody>
							<tr>
								<td colspan="2"><a href="/group?id=@group["id"].ToString()">@group["name"].ToString()</a></td>
							</tr>
							<tr>
								<td rowspan="2"><a href="/group?id=@group["id"].ToString()"><img alt="" src="~/api/thumb?id=@group["id"].ToString()&type=group" style="width: 64px; height: 64px;" /></a></td>
								<td class="user" rowspan="2">
									<div style="height:32px; overflow: hidden">@group["desc"].ToString()</div>

									<div class="smallgray">@group["vids"].ToString() Videos</div>

									<div class="smallgray">@group["views"].ToString() Views</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			}
			<div style="width:max-content;"></div>
		</div>
		<div>&nbsp;</div>
	</td>
	<td style="width: 330px;">
		<div class="homeheader"><span style="font-size:14px;"><strong>The Forum</strong></span></div>
		<hr style="margin-right:0px;" />
		<div>&nbsp;</div>
		@if (HttpContextAccessor.HttpContext.Request.Cookies["session"] == null)
		{
			<div style="border-style: solid; border-color: black; border-width: 1px; padding: 8px;margin-bottom: 16px;">
				<div style="text-align: center;"><font color="#555555"><b>Want to join the community?</b></font></div>

				<div style="text-align: center;"><a href="/signup">Create an Account</a> or <a href="/login">Sign In</a> Now!</div>
			</div>
		}
		<div style="border-style: solid; border-color: #77f; border-width: 1px; padding: 8px; background-color: #bbf;">
			<div><span style="font-size:14px;color:#33c;"><b>What&#39;s New</b></span></div>

			<div>&nbsp;</div>

			<div><span style="color:#33c;">Private Alpha Testing</span></div>

			<div>wow! so cool</div>
		</div>
	</td>
</tr>



