@using Newtonsoft.Json.Linq
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@{
	string username = string.Empty;
	string displayName = string.Empty;
	string messagesCount = "0";
	string ismessages = "normal";
	string ismessagescolors = "#000";
	string datapath = @"D:\Freestyle\Debug\net6.0\data\user\";
	Random random = new Random();
	if (HttpContextAccessor.HttpContext.Request.Cookies["username"] != null)
	{
		username = HttpContextAccessor.HttpContext.Request.Cookies["username"].ToString();
		displayName = string.Empty;
		if (HttpContextAccessor.HttpContext.Request.Cookies["session"] == null)
		{
			HttpContextAccessor.HttpContext.Response.Cookies.Delete("username");
			HttpContextAccessor.HttpContext.Response.Cookies.Delete("password");
			HttpContextAccessor.HttpContext.Response.Redirect(HttpContextAccessor.HttpContext.Request.Path + HttpContextAccessor.HttpContext.Request.QueryString);
		}
		else
		{
			if ((DateTimeOffset.UtcNow - DateTimeOffset.FromUnixTimeMilliseconds(long.Parse(HttpContextAccessor.HttpContext.Request.Cookies["session"].ToString()))).TotalDays >= 1)
			{
				HttpContextAccessor.HttpContext.Response.Cookies.Delete("username");
				HttpContextAccessor.HttpContext.Response.Cookies.Delete("password");
				HttpContextAccessor.HttpContext.Response.Redirect(HttpContextAccessor.HttpContext.Request.Path + HttpContextAccessor.HttpContext.Request.QueryString);
				return;
			}
			HttpContextAccessor.HttpContext.Response.Cookies.Append("session", DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString());
			FileStream stream = new(datapath + @"..\profiles\" + username, FileMode.Open, FileAccess.Read);
			byte[] result = new byte[stream.Length];
			_ = await stream.ReadAsync(result, 0, (int)stream.Length);
			string data = System.Text.Encoding.UTF8.GetString(result);
			JObject json = JObject.Parse(data);
			json["lastseen"] = DateTime.UtcNow.ToString("s");
			displayName = json["name"].ToString();
			if (json["displayName"] != null)
			{
				displayName = json["displayName"].ToString();
			}
			stream.Close();
			stream.Dispose();
			using (FileStream fs = new(datapath + @"..\profiles\" + username, FileMode.Open, FileAccess.Write))
			{
				byte[] info = new System.Text.UTF8Encoding(true).GetBytes(json.ToString());
				fs.Write(info, 0, info.Length);
			}
		}
	}
	bool isLoggedIn = (HttpContextAccessor.HttpContext.Request.Cookies["username"] != null);
	if (System.IO.File.Exists(datapath + username))
	{
		FileStream stream = new(datapath + username, FileMode.Open, FileAccess.Read);
		byte[] result = new byte[stream.Length];
		_ = await stream.ReadAsync(result, 0, (int)stream.Length);
		string data = System.Text.Encoding.UTF8.GetString(result);
		JObject json = JObject.Parse(data);
		messagesCount = json["messageCount"].ToString();
		ismessages = ((messagesCount == "0") ? "normal" : "bold");
		ismessagescolors = ((messagesCount == "0") ? "#000" : "#b22");
		stream.Close();
		stream.Dispose();
	}
}
<!doctype html>
<html>
<head>
	<title>Freestyle</title>
	<link href="~/css/style.css" media="all" rel="stylesheet" type="text/css" />
	@if (HttpContextAccessor.HttpContext.Request.Path.ToString().Contains("/profile") || HttpContextAccessor.HttpContext.Request.Path.ToString().Contains("/studio/prof"))
	{
		<style>
			.footer {
				display: none;
			}
		</style>
	}
	@if (HttpContextAccessor.HttpContext.Request.Query["id"] != Microsoft.Extensions.Primitives.StringValues.Empty && HttpContextAccessor.HttpContext.Request.Path.ToString().Contains("/profile"))
	{
		<link id="customStyle" href="~/api/profileCSS?id=@HttpContextAccessor.HttpContext.Request.Query["id"].ToString()" media="all" rel="stylesheet" type="text/css" />
	}
	else if (HttpContextAccessor.HttpContext.Request.Path.ToString().Contains("/studio/prof") && HttpContextAccessor.HttpContext.Request.Cookies["username"] != null)
	{
		<link id="customStyle" href="~/api/profileCSS?id=@HttpContextAccessor.HttpContext.Request.Cookies["username"].ToString()" media="all" rel="stylesheet" type="text/css" />
	}
	<link rel="icon" type="image/x-icon" href="/img/favicon.png">
	<script src="/js/jquery.min.js"></script>
	<script>
		function updateParam(key, value) {
				key = escape(key); value = escape(value);

			var kvp = document.location.search.substr(1).split('&');
			if (kvp == '') {
				document.location.search = '?' + key + '=' + value;
			}
			else {

				var i = kvp.length; var x; while (i--) {
					x = kvp[i].split('=');

					if (x[0] == key) {
						x[1] = value;
						kvp[i] = x.join('=');
						break;
					}
				}

				if (i < 0) { kvp[kvp.length] = [key, value].join('='); }

				//this will reload the page, it's likely better to store this until finished
				document.location.search = kvp.join('&');
			}
		}
		function signout() {
			urlParam = function(name){
			var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
			if (results == null){
			   return null;
			}
			else {
			   return decodeURI(results[1]) || 0;
			}
			}
			var http = new XMLHttpRequest();
			var params = '';
			http.open("POST", "/api/signout", true);
			http.setRequestHeader("Content-type", "application/json");

			http.onreadystatechange = function() { //Call a function when the state changes.
				if (http.readyState == XMLHttpRequest.DONE && http.status == 200) {
					var json = JSON.parse(http.responseText);
					if (json.redirect != "True")
					{
						window.location = "/login";
					} else {
						location.reload();
					}
				}
			}
			http.send(params);
		}
	</script>
</head>
<body style="margin: 0px;">
	<div style="width:100%; min-width: 930px; background: white; border-radius: 0px;" class="layoutheader">
		<table align="center" border="0" cellpadding="0" cellspacing="0" style="width:930px;">
			<tbody>
				<tr style="height:64px">
					<td style="padding: 8px 0px 4px;"><a href="/"><img class="HeaderLogo" alt="Logo" src="~/img/FreestyleLogoDark.png" style="width: 217px; height: 55px;" /></a></td>
					<td style="width: 280px; text-align: right;padding: 8px 0px">
						@{
							if (isLoggedIn)
							{
								<![if (!IE)|(gte IE 9)]>
								<div class="accountdetails">
									<div class="dropdown">
										<a class="dropbtn" title="@username" href="/my">@displayName<img src="~/img/dar.png" style="margin-left: 5px;margin-bottom: 2px;" /></a>
										<div class="dropdown-content">
											<a href="/my">My Profile</a>
											<a href="/studio/vid">My Videos</a>
											<a href="/studio/playlist">My Playlists</a>
											<a href="/studio/group">My Groups</a>
											<a href="/favorites">My Favorites</a>
											<a href="/my?q=follow">My Friends</a>
											<a href="/my?q=follow">My Follows</a>
											<a href="/settings">My Account</a>
											<a href="#" onclick="signout();">Sign Out</a>
										</div>
									</div> | <a href="/messages">Inbox</a> <a style="color: @ismessagescolors" href="/messages">(<span style="font-weight: @ismessages;">@messagesCount</span>)</a> | <a href="/help">Help</a>
								</div>
								<![endif]>
							}
							else
							{
								<![if (!IE)|(gte IE 9)]>
								<div class="accountdetails"><a href="/signup">Create Account</a> | <a href="/login">Log In</a> | <a href="/help">Help</a></div>
								<![endif]>
							}
						}
					</td>
				</tr>
				<tr>
					<td colspan="2">
						@if (true)
						{
							<div class="headerNew">
								<span><a class="headerHome@((HttpContextAccessor.HttpContext.Request.Path.ToString() == "/") ? "Active" : string.Empty)" href="/">Home</a><a class="headerVideos@((HttpContextAccessor.HttpContext.Request.Path.ToString() == "/videos") ? "Active" : string.Empty)" href="/videos">Videos</a><a class="headerPeople@((HttpContextAccessor.HttpContext.Request.Path.ToString() == "/people") ? "Active" : string.Empty)" href="/people">People</a><a class="headerGroups@((HttpContextAccessor.HttpContext.Request.Path.ToString() == "/groups") ? "Active" : string.Empty)" href="/groups">Groups</a><a class="headerFeeds@((HttpContextAccessor.HttpContext.Request.Path.ToString() == "/feeds") ? "Active" : string.Empty)" href="/feeds">Feeds</a><a class="headerCommunity@((HttpContextAccessor.HttpContext.Request.Path.ToString() == "/community") ? "Active" : string.Empty)" href="/community">Community</a><a class="headerUpload@((HttpContextAccessor.HttpContext.Request.Path.ToString() == "/upload") ? "Active" : string.Empty)" href="/upload">Upload</a></span>
								<![if (!IE)|(gte IE 9)]>
								<div style="float:right;position:relative;top:3px;right:5px;"><form action="/search"><input name="q" placeholder="Search Freestyle" maxlength="255" style="width: 200px;height:19px;margin-right:5px;padding-block:0px;padding-inline:0px;" type="search" /><button type="submit" id="searchIcon" style="height:100%;position:relative;border:none;background:none;padding:0px;vertical-align:middle;"><img alt="" src="/img/searchIcon.png" style="width: 15px; height: 15px;" /></button></form></div>
								<![endif]>
							</div>
						}
						else
						{
							<div class="header">
								<span style="font-size:14px;"><a class="headertext" href="/">Home</a> | <a class="headertext" href="/videos">Videos</a> | <a class="headertext" href="/people">People</a> | <a class="headertext" href="/groups">Groups</a> | <a class="headertext" href="/feeds">Feeds</a> | <a class="headertext" href="/community">Community</a> | <a class="headertext" href="/upload">Upload</a></span>
								<![if (!IE)|(gte IE 9)]>
								<div style="float:right;position:relative;top:-2px;"><form action="/search"><input name="q" maxlength="255" style="width: 200px;height:19px;margin-right:5px;padding-block:0px;padding-inline:0px;" type="search" /><input type="submit" style="height:100%;position:relative;" value="Search" /></form></div>
								<![endif]>
							</div>
						}
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	<div style="height: 16px; width: 100%; min-width: 930px;" class="trans">
	</div>
	<table align="center" border="0" cellpadding="0" cellspacing="0" style="width:930px;">
		<tbody>
			@RenderBody()
		</tbody>
	</table>
	<div class="footer">
		<div style="height: 16px;"></div>
		<div style="width: 100%;">
			<table align="center" border="0" cellpadding="0" cellspacing="0" style="width:930px;">
				<tbody>
					<tr>
						<td>
							<hr/>
							<div><a href="/forum">Forum</a> | <a href="/rss">RSS</a> | <a href="/terms">Terms of Service</a> | <a href="/privacy">Privacy Policy</a> | <a href="/guidelines">Community Guidelines</a> | <a href="/contact">Contact</a> | <a href="/test">Try out new features!</a></div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<div style="height: 32px;"></div>
</body>
</html>

